ICanBoogie.Modules.Thumbnailer=function(){var a=new function(){this.RESIZE_NONE="none",this.RESIZE_FIT="fit",this.RESIZE_FILL="fill",this.RESIZE_FIXED_HEIGHT="fixed-height",this.RESIZE_FIXED_HEIGHT_CROPPED="fixed-height-cropped",this.RESIZE_FIXED_WIDTH="fixed-width",this.RESIZE_FIXED_WIDTH_CROPPED="fixed-width-cropped",this.RESIZE_SURFACE="surface",this.RESIZE_SIMPLE="simple",this.RESIZE_CONSTRAINED="constrained",this.assertSize=function(a,b,c){switch(c){case this.RESIZE_FIXED_WIDTH:if(!a)throw Error("Width is required for the "+c+" resize method.");break;case this.RESIZE_FIXED_HEIGHT:if(!b)throw Error("Height is required for the "+c+" resize method.");break;default:if(!a||!b)throw Error("Both width and height are required for the "+c+" resize method.")}return!0}},b=new function(){this.defaults={background:null,"default":null,format:"jpeg",filter:null,height:null,method:"fill","no-interlace":!1,"no-upscale":!1,overlay:null,path:null,quality:90,src:null,width:null},this.shorthands={b:"background",d:"default",f:"format",ft:"filter",h:"height",m:"method",ni:"no-interlace",nu:"no-upscale",o:"overlay",p:"path",q:"quality",s:"src",v:"version",w:"width"},this.normalize=function(a){var b=this.defaults,c=Object.keys(b),d=this.shorthands,e=Object.clone(b);return Object.each(a,function(a,b){a&&(d[b]&&(b=d[b]),e[b]=a)}),Object.filter(e,function(a,b){return Object.contains(c,b)})},this.filter=function(a){var b=this.defaults,d=(Object.keys(b),this.normalize(a));return Object.filter(d,function(a,c){return a&&a!=b[c]})}};return{Image:a,Thumbnail:new Class({options:{},initialize:function(a,b){this.src=a,this.options=b},toString:function(){var c=b.normalize(this.options),d=this.src,e=c.width,f=c.height,g=c.method,h=null;a.assertSize(e,f,g);var i=d.match(/repository\/files\/image\/(\d+)/);return i.length&&(d="/api/images/"+i[1]),d+="/"+(e||"")+"x"+(f||""),g&&(d+="/"+g),delete c.width,delete c.height,delete c.method,h=Object.toQueryString(b.filter(c)),h&&(d+="?"+h),d}}),Version:b}}(),Brickrouge.Widget.AdjustThumbnailOptions=function(){var a=ICanBoogie.Modules.Thumbnailer.Version;return a.defaults.lightbox=null,a.shorthands.lb="lightbox",new Class({Implements:[Events],initialize:function(b){this.element=b=document.id(b),this.controls={},Object.each(a.defaults,function(a,c){var d=b.getElement('[name="'+c+'"]');d&&(this[c]=d)},this.controls),b.addEvent("change",this.onChange.bind(this)),this.checkMethod(),this.checkQuality()},checkMethod:function(){var a=this.controls.height,b=this.controls.width;switch(this.controls.method.get("value")){case"fixed-height":a.readOnly=!1,b.readOnly=!0;break;case"fixed-width":a.readOnly=!0,b.readOnly=!1;break;default:b.readOnly=!1,a.readOnly=!1}},checkQuality:function(){var a=this.controls.format.get("value");this.controls.quality.getParent().setStyle("display","jpeg"!=a?"none":"")},getValue:function(){var a=this.element.toQueryString().parseQueryString();return this.controls.width.readOnly&&delete a.width,this.controls.height.readOnly&&delete a.height,a},setValue:function(b){Object.each(a.normalize(b),function(a,b){var c=this[b];c&&("checkbox"==c.type?c.set("checked",!!a):c.set("value",a))},this.controls),this.checkMethod(),this.checkQuality()},onChange:function(){this.checkMethod(),this.checkQuality(),this.fireEvent("change",{target:this,values:this.getValue()})}})}(),Brickrouge.Widget.AdjustThumbnailVersion=new Class({Implements:[Options,Events],initialize:function(a){function h(){switch(e.get("value")){case"fixed-height":d.readOnly=!1,c.readOnly=!0;break;case"fixed-width":d.readOnly=!0,c.readOnly=!1;break;default:c.readOnly=!1,d.readOnly=!1}}function i(){var a=f.get("value");g.getParent().setStyle("display","jpeg"!=a?"none":"")}this.element=a=$(a);var c=a.getElement('input[name="w"]')||a.getElement('input[name$="[w]"]'),d=a.getElement('input[name="h"]')||a.getElement('input[name$="[h]"]'),e=a.getElement('select[name="method"]')||a.getElement('select[name$="[method]"]'),f=a.getElement('select[name="format"]')||a.getElement('select[name$="[format]"]'),g=a.getElement('input[name="quality"]')||a.getElement('input[name$="[quality]"]');this.elements={w:c,h:d,method:e,format:f,quality:g,"no-upscale":a.getElement('input[name="no-upscale"]')||a.getElement('input[name$="[no-upscale]"]'),background:a.getElement('input[name="background"]')||a.getElement('input[name$="[background]"]'),filter:a.getElement('input[name="filter"]')||a.getElement('input[name$="[filter]"]')},Object.each(this.elements,function(a){a&&a.addEvent("change",this.fireChange.bind(this))},this),h(),i(),e.addEvent("change",h),f.addEvent("change",i)},fireChange:function(){},setValue:function(a){"string"==typeOf(a)&&(a=JSON.decode(a)),a&&Object.each(a,function(a,b){this.elements[b]&&("no-upscale"==b||"interlace"==b?this.elements[b].set("checked",a):this.elements[b].set("value",a))},this)}}),Brickrouge.Widget.PopThumbnailVersion=new Class({Extends:Brickrouge.Widget.Spinner,initialize:function(a,b){this.parent(a,b),this.control=this.element.getElement("input")},open:function(){this.resetValue=this.getValue(),this.popover?(this.popover.adjust.setValue(this.resetValue),this.popover.show()):new Request.Widget("adjust-thumbnail-version/popup",function(a){this.attachAdjust(a),this.popover.show(),this.popover.addEvent("action",this.onAction.bind(this))}.bind(this)).get({value:this.getValue()})},encodeValue:function(a){return a&&"object"==typeOf(a)&&(a=JSON.encode(a)),a},decodeValue:function(a){try{return JSON.decode(a)}catch(b){return null}},formatValue:function(a){return a?("string"==typeOf(a)&&(a=a.parseQueryString()),""+(a.width||"<em>auto</em>")+"Ã—"+(a.height||"<em>auto</em>")+" "+a.method+" ."+a.format):""},attachAdjust:function(a){this.popover=new Icybee.Widget.AdjustPopover(a,{anchor:this.element})},change:function(){},onAction:function(a){switch(a.action){case"use":var b=a.popover.element.toQueryString().parseQueryString();b.width||b.height||(b=null),this.setValue(b);break;case"remove":this.setValue(null);break;case"cancel":this.setValue(this.resetValue)}this.popover.hide()}});